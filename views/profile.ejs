<% layout('layout')%>
    <script>
        function changeStatusIcon(value) {
            if (value == 1) {
                document.getElementById("statusIconSpan").setAttribute("class", "glyphicon glyphicon-flag color-green");
            } else if (value == 2) {
                document.getElementById("statusIconSpan").setAttribute("class", "glyphicon glyphicon-flag color-orange");
            } else if (value == 3) {
                document.getElementById("statusIconSpan").setAttribute("class", "glyphicon glyphicon-flag color-red");
            } else if (value == 4) {
                document.getElementById("statusIconSpan").setAttribute("class", "glyphicon glyphicon-flag color-blue");
            }
        }
    </script>

    <script>
        function changeRoleIcon(value) {
            if (value == 1) {
                document.getElementById("roleIconSpan").setAttribute("class", "glyphicon glyphicon-star color-yellow");
            } else if (value == 2) {
                document.getElementById("roleIconSpan").setAttribute("class", "glyphicon glyphicon-star color-red");
            } else if (value == 3) {
                document.getElementById("roleIconSpan").setAttribute("class", "glyphicon glyphicon-star color-blue");
            }
        }
    </script>
    <!--Users Page Content-->
    <div class="container-fluid">
        <div id="divDisplay" class="box-typical box-typical-padding">
            <header class="section-header">
                <div class="tbl">
                    <div class="tbl-row">
                        <div class="tbl-cell">
                            <h4>
                                <i class="font-icon fa fa-user"></i>
                                <%= heading %>
                            </h4>
                            <ol class="breadcrumb breadcrumb-simple">
                                <li><small><a href="/">Home</a></small></li>
                                <li class="active">
                                    <small> <%= heading %></small>
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>
            </header>
            <!--.page-content-header-->
            <form id="form-user" name="form-user" method="post">
                <h5 class="m-t-lg with-border">Member Information</h5>
                <div class="row">
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6">
                                <fieldset class="form-group">
                                    <label class="form-label semibold" for="firstname">First Name<span class="color-red">&nbsp;*</span></label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <span class="glyphicon glyphicon-user"></span>
                                        </div>
                                        <% if(data == null){ %>
                                            <input id="firstname" name="firstname" class="form-control" type="text" placeholder="First Name" data-validation="[NOTEMPTY]">
                                            <% } else{ %>
                                                <input id="firstname" class="form-control" name="firstname" type="text" placeholder="First Name" data-validation="[NOTEMPTY]" value='<%= data.firstname%>'>
                                                <% } %>
                                    </div>
                                </fieldset>
                            </div>
                            <div class="col-md-6">
                                <fieldset class="form-group">
                                    <label class="form-label semibold" for="lastname">Last Name<span class="color-red">&nbsp;*</span></label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <span class="glyphicon glyphicon-user"></span>
                                        </div>
                                        <% if(data == null){ %>
                                            <input id="lastname" class="form-control" name="lastname" type="text" placeholder="Last Name" data-validation="[NOTEMPTY]">
                                            <% } else{ %>
                                                <input id="lastname" class="form-control" name="lastname" type="text" placeholder="Last Name" data-validation="[NOTEMPTY]" value='<%= data.lastname%>'>
                                                <% } %>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <!--.row-->
                        <div class="row">
                            <div class="col-md-6">
                                <fieldset class="form-group">
                                    <label class="form-label semibold" for="username">Username / Email Address<span class="color-red">&nbsp;*</span></label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <span class="glyphicon glyphicon-envelope"></span>
                                        </div>
                                        <% if(data == null){ %>
                                            <input id="email" class="form-control" name="email" type="text" placeholder="example@mail.com" data-validation="[EMAIL]">
                                            <% } else{ %>
                                                <input id="email" value='<%=data.email%>' class="form-control" name="email" type="text" placeholder="example@mail.com" data-validation="[EMAIL]" readonly>
                                                <% } %>
                                    </div>
                                </fieldset>

                            </div>
                            <div class="col-md-6">
                                <fieldset class="form-group">
                                    <label class="form-label semibold" for="mobileno">Mobile No.<span class="color-red">&nbsp;*</span></label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <span class="glyphicon glyphicon-earphone"></span>
                                        </div>
                                        <% if(data == null){ %>
                                            <input type="text" class="form-control" id="phone-with-code-area-mask-input2" name="mobileno" placeholder="Mobile No" data-validation="[NOTEMPTY]">
                                            <% } else{ %>
                                                <input type="text" class="form-control" id="phone-with-code-area-mask-input2" name="mobileno" placeholder="Mobile No" data-validation="[NOTEMPTY]" value='<%=data.mobileno%>'>
                                                <% } %>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <!--.row-->
                        <div class="row">
                            <div class="col-sm-6">
                                <fieldset class="form-group">
                                    <label class="form-label semibold" for="role">Role</label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <% if(data == null){ %>
                                                <span id="roleIconSpan" class="glyphicon glyphicon-star color-yellow"></span>
                                                <% } else{ %>
                                                    <% if(data.role ==1){ %>
                                                        <span id="roleIconSpan" class='glyphicon glyphicon-star color-red'></span>
                                                        <% } else if(data.role ==2){ %>
                                                            <span id="roleIconSpan" class="glyphicon glyphicon-star color-yellow"></span>
                                                            <% } else if(data.role ==3){ %>
                                                                <span id="roleIconSpan" class="glyphicon glyphicon-star color-blue"></span>
                                                                <% } %>
                                                                    <% } %>
                                        </div>

                                        <select onchange="changeRoleIcon(this.value)" id="role" name="role" class="form-control" readonly>
                                            <% if(data.role == 1 ){ %>                                       
                                                <option value="1" selected>Site Administrator</option>   
                                            <% } else if(data.role ==2) { %>            
                                                <option value="2" selected>Manager</option>   
                                            <% } else if(data.role ==3) { %>      
                                                <option value="3" selected>Standard</option>               
                                            <% } %>                                                                                                                                               
                                        </select>
                                    </div>
                                </fieldset>
                            </div>
                            <div class="col-sm-6">
                                <fieldset class="form-group">
                                    <label class="form-label semibold" for="status">Status</label>
                                    <div class="input-group">
                                        <div class="input-group-addon">
                                            <% if(data == null){ %>
                                                <span id="statusIconSpan" class='glyphicon glyphicon-flag color-green'></span>
                                                <% } else{ %>
                                                    <% if(data.status ==1){ %>
                                                        <span id="statusIconSpan" class='glyphicon glyphicon-flag color-green'></span>
                                                        <% } else if(data.status ==2){ %>
                                                            <span id="statusIconSpan" class='glyphicon glyphicon-flag color-orange'></span>
                                                            <% } else if(data.status ==3){ %>
                                                                <span id="statusIconSpan" class='glyphicon glyphicon-flag color-red'></span>
                                                                <% } else if(data.status ==4){ %>
                                                                    <span id="statusIconSpan" class='glyphicon glyphicon-flag color-blue'></span>
                                                                    <% } else { %>
                                                                        <span id="statusIconSpan" class='glyphicon glyphicon-flag'></span>
                                                                        <% } %>
                                                                            <% } %>
                                        </div>
                                        <select onchange="changeStatusIcon(this.value)" id="status" name="status" class="form-control" placeholder="Status" readonly>                             
                                            <% if(data.status == 1 ){ %>                                       
                                                <option value="1" selected>Active</option>   
                                            <% } else if(data.status ==2) { %>            
                                                <option value="2" selected>Suspended</option>   
                                            <% } else if(data.status ==3) { %>      
                                                <option value="3" selected>Deleted</option>   
                                            <% } else if(data.status ==4) { %>   
                                                <option value="4" selected>Pending</option>   
                                            <% } %>                                                                                               
                                        </select>
                                    </div>
                                </fieldset>
                            </div>
                        </div>
                        <!--.row-->
                    </div>
                    <div class="col-md-4">
                        <section class="box-typical profile-side-user">
                            <div class="row">
                                <div class="col-12">
                                    <button type="button" class="avatar-preview avatar-preview-128">
                                                <img id="profileImage" class="profileImage" src="/img/avatar-1-128.png" alt=""/>
                                                <span class="update">
                                                    <i class="font-icon font-icon-picture-double"></i>
                                                    Update Photo
                                                </span>
                                                <input id="btnImagePreview" class="form-control" onchange="javascript:encodeAndPreviewProfileImageFile(this);" name="btnImagePreview" accept="image/png" type="file"/>
                                                <input id="btnImageUpload" class="form-control" onchange="javascript:encodeAndUploadProfileImageFile(this);" name="btnImageUpload" accept="image/png" type="file"/>
                                    </button>
                                </div>
                            </div>
                            <div class="row text-right">
                                <div class="col-6 text-center">
                                    <button type="button" onclick="javascript:$('#btnImagePreview').click();" ; class="btn btn-rounded">Preview</button>
                                </div>
                                <div class="col-6 text-center">
                                    <button type="button" onclick="javascript:$('#btnImageUpload').click();" ; class="btn btn-rounded">Change</button>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
                <!-- row -->
                <div class="row">
                    <div class="col-md-6">
                        <fieldset class="form-group">
                            <label class="form-label semibold" for="creator">Created By</label>
                            <div class="input-group">
                                <div class="input-group-addon">
                                    <span class="glyphicon glyphicon-user"></span>
                                </div>
                                <input type="text" value='<%= data == null ? ' ': (data.createdby == 1 ? 'Site Administrator ' : 'Member ')%>' class="form-control" id="creator" name="creator" placeholder="Created By" readonly>
                            </div>
                        </fieldset>
                    </div>
                    <div class="col-md-6">
                        <fieldset class="form-group">
                            <label class="form-label semibold" for="creationdate">Creation Date</label>
                            <div class="input-group">
                                <div class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </div>
                                <% if(data == null){ %>
                                    <input type="text" class="form-control" id="creationdate" name="creationdate" placeholder="Creation Date" value='<%= new Date().toLocaleString()%>' readonly>
                                    <% } else{ %>
                                        <input type="text" class="form-control" id="creationdate" name="creationdate" placeholder="Creation Date" value='<%= new Date(data.created).toLocaleString()%>' readonly>
                                        <% } %>
                            </div>
                        </fieldset>
                    </div>
                </div>
                <h5 class="with-border m-t-0">Site Memberships</h5>
                <div class="row">
                    <div class="col-md-12">
                        <% if(data == null){ %>
                            <select id="sites" name="sites" class="select2" multiple="multiple" title="Add areas the user has access to." readonly disabled>     
                                <!-- <% sites.forEach(function(site) { %>
                                    <option value=<%= site.uuid %> ><%= site.name + " - (" + site.uuid +")" %></option>
                                <% }); %> -->
                            </select>
                            <% } else{ %>
                                <select <% data.role==1 ? '' : 'disabled'%> id="sites" name="sites" class="select2" multiple="multiple" title="Add areas the user has access to." readonly disabled>     
                                <!-- <% sites.forEach(function(site) { %>
                                    <option selected value=<%= site.uuid %> ><%= site.name + " - (" + site.uuid +")" %></option>
                                <% }); %> -->
                                <% usersites.forEach(function(usersite) { %>
                                    <option selected value=<%= usersite.uuid %> ><%= usersite.name + " - (" + usersite.uuid +")"%></option>
                                <% }); %>
                            </select>
                                <% } %>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">&nbsp;</div>
                    <div class="col-md-6 text-right">
                        <div class="form-group">
                            <label class="form-label semibold" for="exampleInput">&nbsp;</label>
                            <% if(data != null){ %>
                                <button type="submit" formaction="#" class="swal-btn-delete btn btn-rounded btn-danger">Reset Password</button>
                                <button type="submit" formaction="#" class="swal-btn-update btn btn-rounded">Update Profile</button>
                                <% } %>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- stylesheets for the page -->
    <link rel="stylesheet" href="/css/separate/pages/user.min.css">
    <link rel="stylesheet" href="/css/separate/pages/profile.min.css">
    <link rel="stylesheet" href="/css/separate/pages/profile-2.min.css">

    <!-- javascripts for the page -->
    <script src="/js/lib/jquery-tag-editor/jquery.caret.min.js"></script>
    <script src="/js/lib/jquery-tag-editor/jquery.tag-editor.min.js"></script>
    <script src="/js/lib/bootstrap-select/bootstrap-select.min.js"></script>
    <script src="/js/lib/select2/select2.full.min.js"></script>
    <script src="/js/lib/html5-form-validation/jquery.validation.min.js"></script>
    <script>
        $(function() {
            /* ==========================================================================
             Validationform-user
             ========================================================================== */

            $('#form-user_v1').validate({
                submit: {
                    settings: {
                        inputContainer: '.form-group'
                    }
                }
            });

            $('#form-user_v2').validate({
                submit: {
                    settings: {
                        inputContainer: '.form-group',
                        errorListClass: 'form-error-text-block',
                        display: 'block',
                        insertion: 'prepend'
                    }
                }
            });

            $('#form-user_v1').validate({
                submit: {
                    settings: {
                        inputContainer: '.form-group',
                        errorListClass: 'form-tooltip-error'
                    }
                }
            });

            $('#form-signup_v2').validate({
                submit: {
                    settings: {
                        inputContainer: '.form-group',
                        errorListClass: 'form-tooltip-error'
                    }
                }
            });
        });
    </script>
    <script src="/js/lib/input-mask/jquery.mask.min.js"></script>
    <!-- scripts for the page -->
    <script>
        $(document).ready(function() {
            $('.swal-btn-delete').click(function(e) {
                e.preventDefault();
                swal({
                        title: "Are you sure?",
                        text: "You will not be able to undo this action!",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonClass: "btn-danger",
                        confirmButtonText: "Yes, reset it!",
                        cancelButtonText: "No, cancel please!",

                        closeOnConfirm: false,
                        closeOnCancel: false
                    },
                    function(isConfirm) {
                        if (isConfirm) {
                            swal({
                                    title: "Reset!",
                                    text: "You will now be taken to the reset screen.",
                                    type: "success",
                                    confirmButtonClass: "btn-success",
                                    closeOnConfirm: false
                                },
                                function(isConfirm) {
                                    if (isConfirm) {
                                        swal.close();
                                        document.getElementById("form-user").action = "/password";
                                        document.getElementById("form-user").submit();
                                    }
                                }
                            );
                        } else {
                            swal({
                                title: "Cancelled!",
                                text: "Action cancelled. No changes were made.",
                                type: "error",
                                confirmButtonClass: "btn-danger",
                                closeOnConfirm: false,
                                closeOnCancel: false
                            });
                        }
                    }
                );

            });

            $('.swal-btn-update').click(function(e) {
                e.preventDefault();
                swal({
                        title: "Are you sure?",
                        text: "Do you really want to make these changes?",
                        type: "info",
                        showCancelButton: true,
                        cancelButtonClass: "btn-default",
                        confirmButtonText: "Yes, change it!",
                        confirmButtonClass: "btn-primary",
                        closeOnConfirm: false,
                        closeOnCancel: false
                    },
                    function(isConfirm) {
                        if (isConfirm) {
                            swal({
                                    title: "Changed!",
                                    text: "The user information will be updated now.",
                                    type: "success",
                                    confirmButtonClass: "btn-success",
                                    closeOnConfirm: false
                                },
                                function(isConfirm) {
                                    if (isConfirm) {
                                        swal.close();
                                        document.getElementById("form-user").action = "/profile/update/<%= user.uuid %>";
                                        document.getElementById("form-user").submit();
                                    }
                                });
                        } else {
                            swal({
                                title: "Cancelled!",
                                text: "Action cancelled. No changes were made.",
                                type: "error",
                                confirmButtonClass: "btn-danger"
                            });
                        }
                    });
            });
        });
    </script>
    <script>
        function encodeAndUploadProfileImageFile(element) {
            console.log(element.files.length);

            if (element.files.length > 0) {
                var file = element.files[0];
                console.log(file);
                var reader = new FileReader();
                reader.onloadend = function() {
                    console.log('RESULT', reader.result)
                    $(".profileImage").attr("src", this.result)

                    var result = $.post('/profile/image_upload', {
                        file: reader.result,
                        useruuid: '<%= user.uuid %>',
                        extension: file.type.split("/")[1]
                    });
                    result.success(function() {
                        alert('done');
                    });
                    //alert(document.getElementById("image").getAttribute("data-encodestring"));

                }
                reader.readAsDataURL(file);
            }
        }

        function encodeAndPreviewProfileImageFile(element) {
            if (element.files.length > 0) {
                var file = element.files[0];
                console.log(file);
                var reader = new FileReader();
                reader.onloadend = function() {
                    $(".profileImage").attr("src", this.result)
                }
                reader.readAsDataURL(file);
            }
        }
        $(document).ready(function() {
            var img = new Image();
            img.onload = function() {
                $("#profileImage").attr("src", this.src + "?dummy=" + new Date().toISOString());
                // alert($("#profileImage").attr("src"));
            }
            img.onerror = function() {
                $("#profileImage").attr("src", "/img/avatar-1-128.png")
            }
            img.src = "/img/users/<%= user.uuid %>.png";
        });
    </script>